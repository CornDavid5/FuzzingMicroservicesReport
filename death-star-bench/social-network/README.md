# Social Network
This end-to-end microservice simulate a real social media network.

Important:
- The following report only considers the [docker default deployment](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/docker-compose.yml) scenario.
- This project also supports `TLS`, `docker swarm`, and `redis sharding` mode.
- This project also supports deployment using `openshift`, and the service interaction graph in the README is based on this `openshift` deployment.

# Task 2 & Task 3
There are totally 27 microservices in this project. 2 for front-end, 13 for business logic, 11 for caching and storage, and 1 for tracing.

### Notes for Task 2 and Task 3
- Ubuntu default app repository only has docker-compose v1. If you have install docker-compose using `apt install`, you will encounter following error: `Version in "./docker-compose.yml" is unsupported.`  [Fix](https://stackoverflow.com/questions/42139982/version-in-docker-compose-yml-is-unsupported-you-might-be-seeing-this-error)
- The interaction between services is done by Apache Thrift RPC call. The data passed in each RPC call is implementation detail, I only include the Thrift struct in each section not the actual data.
- Thrift defines RPC calls and related data types can be found in [here](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/social_network.thrift)
- The autogenerated code for business logic service by Thrift is in [here](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/gen-cpp)
- The interaction between service and jaeger is ignored in the following section.

### Service Summary
Following sections are all collapsible, expand them to see more.

<details>
  <summary>jaeger-agent</summary>

  ### Functionality
  distributed tracing system

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/jaeger-config.yml)

  ### Interactions
  All frontend and business logic microservice will connect to jaeger to provide tracing information.

</details>

<details>
  <summary>media-frontend</summary>

  ### Functionality
  a OpenResty/nginx server served as API gateway for querying and uploading images.

  It provides following endpoints:
  - /get-media
  - /upload-media

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/media-frontend/conf)

  [request handler](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/media-frontend/lua-scripts)

  [docker](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/docker/media-frontend)

  ### Interactions
  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | media-mongodb | media | media | (filename = media_id + '.' +  media_type, file = media_file) |

</details>

<details>
  <summary>media-memcached</summary>

  ### Functionality
  This service provides caching for `media-frontend`.

  - Note: I couldn't find any usage in the source code for default docker compose deployment. Maybe it was used in other scenario.

  ### Related Files
  N/A

  ### Interactions
  N/A

</details>

<details>
  <summary>media-mongodb</summary>

  ### Functionality
  This service provides storage for all image.

  ### Related Files
  N/A

  ### Interactions
  N/A

</details>

<details>
  <summary>nginx-thrift</summary>

  ### Functionality
  a OpenResty/nginx served as API gateway to handle all incoming requests except image related requests.

  It provides following endpoints:
  - /
  - /api/user/register
  - /api/user/follow
  - /api/user/unfollow
  - /api/user/login
  - /api/post/compose
  - /api/user-timeline/read
  - /api/home-timeline/read
  - /api/user/get_follower
  - /api/user/get_followee

  ### Related Files
  [nginx config](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/nginx-web-server/conf)

  [request handler](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/nginx-web-server/lua-scripts)

  [webpage resources](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/nginx-web-server/pages)

  [tracing config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/nginx-web-server/jaeger-config.json)

  [docker](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/docker/openresty-thrift)

  ### Interactions
  | Service | URL | RPC Call | Data Sent |
  | --- | --- | --- | --- |
  | compose-post-service| /api/post/compose| ComposePost| (req_id, username, user_id, post.text, post.media_ids, post.media_types, post.post_type)|
  | home-timeline-service| /api/home-timeline/read| ReadHomeTimeline| (req_id, user_id, start, stop)|
  | social-graph-service | /api/user/follow | Follow | (req_id, post.user_id, post.followee_id) |
  | social-graph-service | /api/user/follow | FollowWithUsername | (req_id, post.user_name, post.followee_name) |
  | social-graph-service | /api/user/unfollow| Unfollow| (req_id, post.user_id, post.followee_id)|
  | social-graph-service | /api/user/unfollow| UnfollowWithUsername| (req_id, post.user_name, post.followee_name)|
  | social-graph-service| /api/user/get_follower| GetFollowers| (req_id, user_id)|
  | social-graph-service| /api/user/get_followee| GetFollowees| (req_id, user_id)|
  | user-service | /api/user/register | RegisterUser | (req_id, post.first_name, post.last_name, post.username, post.password) |
  | user-service| /api/user/login| Login| (req_id, username, password)|
  | user-timeline-service| /api/user-timeline/read| ReadUserTimeline| (req_id, user_id, start, stop)|

</details>

<details>
  <summary>unique-id-service</summary>

  ### Functionality
  This service generates 64-bit unique id with following composition:

  11 bit machine ID + 40-bit timestamp + 12-bit counter
  - 11-bit machine id code by hasing the MAC address
  - 40-bit UNIX timestamp in millisecond precision with custom epoch
  - 12 bit counter which increases monotonically on single process

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L10)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/UniqueIdService)

  ### Interactions
  N/A

</details>

<details>
  <summary>url-shorten-service</summary>

  ### Functionality
  This service generates shorten url in following format: `http://short-url/ + 10 random characters`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L192)

  ### Interactions
  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | url-shorten-mongodb | url-shorten | url-shorten | (shortened_url = shortened_url, expanded_url = original_url) |

</details>

<details>
  <summary>url-shorten-memcached</summary>

  ### Functionality
  This service provides caching for `url-shorten-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L25)

  ### Interactions
  N/A

</details>

<details>
  <summary>url-shorten-mongodb</summary>

  ### Functionality
  This service provides storage for `url-shorten-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L185)

  ### Interactions
  N/A

</details>

<details>
  <summary>media-service</summary>

  ### Functionality
  This service lets user to create post which contains image

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L18)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/MediaService)

  ### Interactions
  N/A

</details>



<details>
  <summary>text-service</summary>

  ### Functionality
  This service lets user create text post which could contain tag/mention/@ or url

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L102)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/TextService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | url-shorten-service | ComposeUrls | (req_id, urls) |
  | user-mention-service | ComposeUserMentions | (req_id, mention_usernames) |


</details>

<details>
  <summary>user-mention-service</summary>

  ### Functionality
  This service lets user create post which tag/mention/@ other user

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L157)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/UserMentionService)

  ### Interactions
  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | user-mongodb | user | user | |

  | Service | Method | Data Sent |
  | --- | --- | --- |
  | user-memcached | get | username + ':' + user_id |

</details>

<details>
  <summary>home-timeline-service</summary>

  ### Functionality
  This service generate a home timeline based on followers

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L178)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/HomeTimelineService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | social-graph-service | GetFollowers | (followers_id, req_id, user_id) |
  | post-storage-service | ReadPosts | (req_id, post_ids) |

  | Service | Method | Data Sent |
  | --- | --- | --- |
  | home-timeline-redis | set | follower_id = (post_id_str, timestamp) |
  | home-timeline-redis | get | user_id |


</details>

<details>
  <summary>home-timeline-redis</summary>

  ### Functionality
  This service provides caching for `home-timeline-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L117)

  ### Interactions
  N/A


</details>

<details>
  <summary>compose-post-service</summary>

  ### Functionality
  This service creates the post and update post database and timeline databases.

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L127)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/ComposePostService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | user-service | ComposeCreatorWithUserId | (req_id, user_id,     username) |
  | text-service | ComposeText | (req_id, text) |
  | media-service | ComposeMedia | (req_id, media_types, media_ids) |
  | unique-id-service | ComposeUniqueId | (post_type) |
  | post-storage-service | StorePost | (post) |
  | user-timeline-service | WriteUserTimeline | (post_id, user_id, timestamp) |
  | home-timeline-service | WriteHomeTimeline | (post_id, user_id, timestamp, user_mentions_id) |

</details>

<details>
  <summary>user-service</summary>

  ### Functionality
  This service provides functionality to register user, compose creator, and verify user login.

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L134)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/UserService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | social-graph-service | InsertUser | (req_id, user_id) |

  | Service | Method | Data Sent |
  | --- | --- | --- |
  | user-memcached | get | username + ":user_id" |
  | user-memcached | get | username + ":login" |

  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | user-mongodb | user | user | (user_id, first_name, last_name, username, salt, salted_password) |

</details>

<details>
  <summary>user-memcached</summary>

  ### Functionality
  This service caches all `username:user_id` and `username:login` data

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L87)

  ### Interactions
  N/A

</details>

<details>
  <summary>user-mongodb</summary>

  ### Functionality
  This service stores all user data

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L80)

  ### Interactions
  N/A

</details>

<details>
  <summary>social-graph-service</summary>

  ### Functionality
  This service generates and maintains a social network graph

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L33)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/SocialGraphService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | user-service | GetUserId | (req_id, user_name) |

  | Service | Method | Data Sent |
  | --- | --- | --- |
  | social-graph-redis | get | user_id + ":followers" |
  | social-graph-redis | get | user_id + ":followees" |
  | social-graph-redis | set | user_id + ":followees" = (followee_id, timestamp) |
  | social-graph-redis | set | followee_id + ":followers" = (user_id, timestamp) |
  | social-graph-redis | del | user_id + ":followees" = (followee_id) |
  | social-graph-redis | del | followee_id + ":followers" = (user_id) |

  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | social-graph-mongodb | social-graph | social-graph | (user_id, followee_id, timestamp) |

</details>

<details>
  <summary>social-graph-mongodb</summary>

  ### Functionality
  This service provides storage for the `social-graph-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L2)

  ### Interactions
  N/A

</details>

<details>
  <summary>social-graph-redis</summary>

  ### Functionality
  This service provides caching for the `social-graph-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L49)

  ### Interactions
  N/A

</details>

<details>
  <summary>post-storage-service</summary>

  ### Functionality
  This service provides functionalities to manage and maintain posts

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L58)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/PostStorageService)

  ### Interactions
  | Service | Method | Data Sent |
  | --- | --- | --- |
  | post-storage-memcached | get | post_id |
  | post-storage-memcached | set | post_id = (post_id, timestamp, text, req_id, post_type, creator(user_id, username), url_list, uesr_mention_list, media_list) |

  | Service | Database | Collection | Data Sent |
  | --- | --- | --- | --- |
  | post-storage-mongodb | post | post | (post_id, timestamp, text, req_id, post_type, creator(user_id, username), url_list, uesr_mention_list, media_list) |

</details>

<details>
  <summary>post-storage-mongodb</summary>

  ### Functionality
  This service stores all post data

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L164)

  ### Interactions
  N/A

</details>

<details>
  <summary>post-storage-memcached</summary>

  ### Functionality
  This service provides caching for `post-storage-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L149)

  ### Interactions
  N/A

</details>

<details>
  <summary>user-timeline-service</summary>

  ### Functionality
  This service provides functionalities to read and write user timeline

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L171)

  [source code](https://github.com/delimitrou/DeathStarBench/tree/master/socialNetwork/src/UserTimelineService)

  ### Interactions
  | Service | RPC Call | Data Sent |
  | --- | --- | --- |
  | post-storage-service | ReadPosts | (req_id, post_ids) |

  | Service | Method | Data Sent |
  | --- | --- | --- |
  | user-timeline-redis | get | user_id |
  | user-timeline-redis | set | user_id = (post_id, timestamp) |

  | Service | Database | Collection | Data Sent |
  | --- | --- | --- |
  | user-timeline-mongodb | user-timeline | user-timeline |  |

</details>

<details>
  <summary>user-timeline-mongodb</summary>

  ### Functionality
  This service stores all user timeline

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L73)

  ### Interactions
  N/A

</details>

<details>
  <summary>user-timeline-redis</summary>

  ### Functionality
  This service provides caching for `user-timeline-service`

  ### Related Files
  [config](https://github.com/delimitrou/DeathStarBench/blob/master/socialNetwork/config/service-config.json#L40)

  ### Interactions
  N/A

</details>

# Task 3
This report provide a Python script to generate a html file for interactive visualization.

Prerequisite:
- Python 3.10+

Generate graph steps:
- (optional) create a virtual environment
- install dependencies, run `python -m pip install -r requirements.txt`
- generate html, run `python generate.py`
  - note: due to a bug in the visualization library, depends on wether you have set the `BROWSER` environement variable, this step will start the browser and open a empty page or it will print out some error messages in the terminal, please ignore them
- manully open the html file in your browser

Interact with the graph:
- you can drag the view
- you can zoom in and zoom out
- you can drag the node
- you can select and highlight a node
- you can hover over an edge to see more details about the interaction
